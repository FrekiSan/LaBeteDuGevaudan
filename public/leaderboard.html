<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Classement</title>
  <link rel="stylesheet" href="./css/leaderboard.css" />
</head>
<body>
  <header class="lb-header">
    <h1>ðŸ† Classement</h1>
    <div class="lb-actions">
      <input id="search" placeholder="Rechercher un pseudoâ€¦" />
      <select id="limit">
        <option value="50">Top 50</option>
        <option value="100" selected>Top 100</option>
        <option value="200">Top 200</option>
      </select>
      <button id="refresh">Actualiser</button>
    </div>
  </header>

  <main>
    <table id="leaderboard">
      <thead>
        <tr>
          <th data-sort="rank">#</th>
          <th data-sort="player">Pseudo</th>
          <th data-sort="time" class="sorted">Temps total</th>
          <th>TerminÃ© le</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="empty" class="hidden">Aucun rÃ©sultat.</p>
  </main>

  <script type="module">
    import { getLeaderboard } from './js/apiClient.js';
    import { formatMs } from './js/timeFormat.js';

    const $ = (s)=>document.querySelector(s);
    let all = [];
    let sortKey = 'time';
    let sortAsc = true;

    async function load() {
      const limit = parseInt($('#limit').value, 10);
      const { entries } = await getLeaderboard(limit);
      all = entries.map((e, idx)=>({ rank: idx+1, player: e.player, time: e.total_time_ms, completed_at: e.completed_at }));
      render();
    }

    function render() {
      const q = ($('#search').value || '').toLowerCase();
      let rows = all.filter(e => e.player.toLowerCase().includes(q));
      rows.sort((a,b)=>{
        const va = a[sortKey], vb = b[sortKey];
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
      const tbody = $('#leaderboard tbody');
      tbody.innerHTML = '';
      rows.forEach((e, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${e.player}</td><td>${formatMs(e.time)}</td><td>${new Date(e.completed_at).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
      $('#empty').classList.toggle('hidden', rows.length>0);
    }

    $('#refresh').addEventListener('click', load);
    $('#search').addEventListener('input', render);
    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort;
        if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = (key !== 'rank'); }
        document.querySelectorAll('th').forEach(h=>h.classList.remove('sorted'));
        th.classList.add('sorted');
        render();
      });
    });

    load();
  </script>
</body>
</html>
